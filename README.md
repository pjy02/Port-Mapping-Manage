# Port-Mapping-Manage

[![Version](https://img.shields.io/badge/version-4.0-blue)](https://github.com/pjy02/Port-Mapping-Manage/blob/main/port_mapping_manager.sh)
[![License](https://img.shields.io/badge/license-MIT-green)](https://github.com/pjy02/Port-Mapping-Manage/blob/main/LICENSE)

> 🚀 **v4.0 重大更新** - 强大且易用的 iptables 端口映射管理脚本，支持 **TCP / UDP** 协议、IPv4/IPv6 双栈、批量操作、规则持久化、实时流量监控、智能诊断等企业级特性。

---

## 📑 项目简介

本脚本旨在简化 Linux 服务器上的大范围端口转发配置与管理，特别适用于 **Hysteria2 / Xray / V2Ray / iperf** 等需要映射大量端口的应用场景。经过 v4.0 全面重构，现已成为功能完善、稳定可靠的企业级端口管理解决方案。

### 🌟 核心特性

* **🎯 智能化管理**：提供直观的交互界面，无需记忆复杂命令
* **🔄 双栈支持**：完整支持 IPv4 / IPv6 双协议栈
* **⚡ 协议灵活**：支持 TCP / UDP，智能协议检测和验证
* **📦 批量操作**：支持配置文件导入/导出，一键批量管理
* **📊 实时监控**：内置流量统计、速率监控和连接状态检测
* **🛡️ 安全可靠**：增强的输入验证、自动备份、智能恢复机制
* **🔧 智能诊断**：全面的系统检测、问题诊断和自动修复
* **⚙️ 持久化配置**：多种持久化方案，确保重启后规则自动恢复
* **🚀 性能优化**：缓存机制、批量处理，大幅提升执行效率
* **🌐 广泛兼容**：支持 Debian / Ubuntu / CentOS / Rocky / AlmaLinux 等主流发行版

---

## 🚀 快速开始

> 需 **root** 权限执行，确保系统已安装 `iptables` / `iptables-save` / `iptables-restore`。

```bash
# 一键下载并运行（示例）
bash <(curl -fsSL https://raw.githubusercontent.com/pjy02/Port-Mapping-Manage/refs/heads/main/install_pmm.sh)
```

### 可选启动参数

| 参数 | 说明 |
| ---- | ---- |
| `-v, --verbose` | 显示更多调试信息 |
| `--no-backup` | 禁用自动备份 |
| `-h, --help` | 查看帮助 |
| `--version` | 显示脚本版本 |

---

## 🖥️ 主菜单一览

### 基础操作
| 序号 | 功能 | 说明 |
| ---- | ---- | ---- |
| 1 | 设置端口映射 (手动配置) | 手动创建新的端口转发规则 |
| 2 | 使用预设配置 | 使用预定义的配置模板 |
| 3 | 查看当前规则 | 显示所有活跃的映射规则 |
| 4 | 规则管理 (编辑/删除) | 编辑或删除现有规则 |
| 5 | 系统诊断 | 检查系统环境和配置状态 |

### 高级功能
| 序号 | 功能 | 说明 |
| ---- | ---- | ---- |
| 6 | 批量操作 (导入/导出) | 批量导入导出规则配置 |
| 7 | 备份管理 | 管理规则备份和恢复 |
| 8 | 实时监控 | 监控端口流量和连接状态 |
| 9 | 恢复设置 | 恢复之前的配置设置 |

### 持久化配置
| 序号 | 功能 | 说明 |
| ---- | ---- | ---- |
| 10 | 永久保存当前规则 | 配置规则持久化 |
| 11 | 检查和修复持久化配置 | 诊断并修复持久化问题 |
| 12 | 测试持久化配置 | 验证持久化配置有效性 |

### 系统管理
| 序号 | 功能 | 说明 |
| ---- | ---- | ---- |
| 13 | 帮助信息 | 显示详细的使用帮助 |
| 14 | 版本信息 | 显示脚本版本和更新日志 |
| 15 | 切换IP版本 (IPv4/IPv6) | 在IPv4和IPv6之间切换 |
| 16 | 检查更新 | 检查并更新到最新版本 |
| 17 | 退出脚本 | 安全退出脚本 |
| 99 | 卸载脚本 | 完全卸载脚本和相关配置 |

---

## 🔧 新增映射示例

1. 选择 **1. 新增端口映射**
2. 按提示依次输入：
   * 起始端口：`6000`
   * 终止端口：`7000`
   * 本地服务端口：`3000`
   * 协议：`1`（TCP）或 `2`（UDP）
3. 确认后即刻生效，可在 **3. 查看当前映射规则** 中验证。

---

## 📂 批量导入示例文件

脚本可读取以下格式的配置文件批量导入规则：

```text:sample_rules.conf
# 格式: start_port:end_port:service_port
6000:7000:3000
8000:9000:4000
10000:12000:5000
```

---

## 🛡️ 备份与恢复

* **自动备份**：每次更改 iptables 前自动备份到 `backups/` 目录，默认保留 10 份
* **选择性清理**：在备份管理菜单输入序号（支持空格/逗号等任意分隔）或输入 `all` 一键清空
* **恢复备份**：按序号选择需要恢复的备份文件，支持覆盖当前全部规则

---

## 📊 实时监控

在 **8. 实时监控** 中，可每秒查看累计数据包、字节数与实时速率，方便排查流量瓶颈。

---

## 🆘 故障排查

1. 确认脚本以 **root** 身份执行
2. 检查 `iptables` 是否正常工作：`iptables -L -n`
3. 若规则未生效，尝试重启相关服务并确保本地端口监听
4. 查看日志：`logs/udp_mapping_*.log`

---

## 📜 License

本项目遵循 **MIT License** 发表，可自由使用、修改、分发。详情参见 [LICENSE](./LICENSE)。

---

## 🔄 升级指南

使用最新安装脚本可自动检测并替换到最新版本：

```bash
bash <(curl -fsSL https://raw.githubusercontent.com/pjy02/Port-Mapping-Manage/main/install_pmm.sh)
```

脚本会在保留现有配置的前提下完成升级。

---

## 🗑️ 卸载脚本

```bash
pmm --uninstall
```

或在主菜单输入 `99` 按提示卸载，并选择是否保留备份文件。

---

## 🤝 贡献指南

欢迎提交 PR 或 Issue！

1. Fork 本仓库并创建分支
2. 提交代码前请运行 `shellcheck` 保证脚本质量
3. 详细描述变更内容和测试结果

---

## 📰 更新日志

### v4.0 - 🚀 重大更新 (2025-01-10)

**🔧 核心修复与优化**
- ✅ 修复函数重复定义问题
- ✅ 修复 `get_iptables_cmd()` 函数参数处理问题
- ✅ 修复 `check_port_conflicts()` IP版本支持问题
- ✅ 修复 `check_rule_active()` 协议检测问题
- ✅ 增强 `sanitize_input()` 安全性验证

**🛡️ 稳定性与兼容性**
- ✅ 修复数组处理兼容性问题
- ✅ 增强错误处理和回滚机制
- ✅ 完善变量验证和环境检查
- ✅ 改进日志记录和调试功能
- ✅ 优化性能和添加缓存机制

**🗑️ 卸载功能重构**
- ✅ 修复规则删除逻辑问题
- ✅ 改进 systemd 服务清理机制
- ✅ 增强权限检查和预验证
- ✅ 安全的自删除机制
- ✅ 智能脚本路径检测

**📚 用户体验提升**
- ✅ 全面更新帮助信息和文档
- ✅ 改进交互界面和错误提示
- ✅ 增强调试模式和详细日志
- ✅ 完善故障排除指南

### 历史版本

| 版本 | 变更 | 日期 |
| ---- | ---- | ---- |
| 3.6  | 完善更新检测功能，优化用户体验 | 2025-08-15 |
| 3.1  | 增加安装脚本依赖自动检测 | 2025-08-02 |
| 3.0  | 全面重构，增加诊断与监控 | 2025-08-02 |
| 2.0  | 初始发布 | 2025-08-01 |

感谢所有贡献者！
